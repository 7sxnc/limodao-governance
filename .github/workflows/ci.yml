name: Continuous Integration
on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  check:
    runs-on: ubuntu-latest
    if: "! contains(github.event.head_commit.message, '[CI Skip]')"
    steps:
      - uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3

      - name: Install
        run: yarn install --immutable --immutable-cache --check-cache

      - name: Checks
        run: yarn check:all

      - name: Audit
        run: yarn audit

  # Continuously deploys the content of main branch
  deploy:
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'push'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v3

      - name: Build
        run: yarn build
        env:
          PUBLIC_URL: ${{ steps.pages.outputs.base_path }}
      
      - name: Upload artifact
        # Automatically uploads an artifact from the './_site' directory by default
        uses: actions/upload-pages-artifact@v1
        with:
          path: dist/
          retention-days: 10

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v9
        id: lighthouse
        with:
          urls: |
            ${{ steps.pages.outputs.base_path }}
          # See https://github.com/GoogleChrome/budget.json
          budgetPath: .github/workflows/budget.json

      - name: Success summary
        if: ${{ success() }}
        run: |
          echo '### Successfully published :white_check_mark:' >> $GITHUB_STEP_SUMMARY
          vaultValues=(${{join(fromJson(steps.lighthouse.outputs.links).*, ' ')}})
          echo "Lighthouse report went live under: ${vaultValues[0]}" >> $GITHUB_STEP_SUMMARY
          for index in ${!vaultValues[@]}
          do
            echo "${vaultKeys[$index]}"
            echo "${vaultValues[$index]}"
          done
          echo "Triggered by **${{ github.actor }}** âˆ™ deployed from **${{ github.ref_name    }}**" >> $GITHUB_STEP_SUMMARY
          echo ' ' >> $GITHUB_STEP_SUMMARY
          echo "**Lighthouse results:**" >> $GITHUB_STEP_SUMMARY
          echo "Performance: ${{ fromJSON(steps.lighthouse.outputs.manifest)[0].summary.performance }}" >> $GITHUB_STEP_SUMMARY
          echo "Accessibility: ${{ fromJSON(steps.lighthouse.outputs.manifest)[0].summary.accessibility }}" >> $GITHUB_STEP_SUMMARY
          echo "Best-practices: ${{ fromJSON(steps.lighthouse.outputs.manifest)[0].summary.best-practices }}" >> $GITHUB_STEP_SUMMARY
          echo "SEO: ${{ fromJSON(steps.lighthouse.outputs.manifest)[0].summary.seo }}" >> $GITHUB_STEP_SUMMARY
          echo "PWA: ${{ fromJSON(steps.lighthouse.outputs.manifest)[0].summary.pwa }}" >> $GITHUB_STEP_SUMMARY
